name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      browser: ${{ steps.filter.outputs.browser }}
      node: ${{ steps.filter.outputs.node }}
      php: ${{ steps.filter.outputs.php }}
      python: ${{ steps.filter.outputs.python }}
      react: ${{ steps.filter.outputs.react }}
      vue: ${{ steps.filter.outputs.vue }}
      symfony: ${{ steps.filter.outputs.symfony }}
      laravel: ${{ steps.filter.outputs.laravel }}
      django: ${{ steps.filter.outputs.django }}
      flask: ${{ steps.filter.outputs.flask }}
      fastapi: ${{ steps.filter.outputs.fastapi }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            browser:
              - 'core/browser/**'
            node:
              - 'core/node/**'
            php:
              - 'core/php/**'
            python:
              - 'core/python/**'
            react:
              - 'frameworks/react/**'
              - 'core/browser/**'
            vue:
              - 'frameworks/vue/**'
              - 'core/browser/**'
            symfony:
              - 'frameworks/symfony/**'
              - 'core/php/**'
            laravel:
              - 'frameworks/laravel/**'
              - 'core/php/**'
            django:
              - 'frameworks/django/**'
              - 'core/python/**'
            flask:
              - 'frameworks/flask/**'
              - 'core/python/**'
            fastapi:
              - 'frameworks/fastapi/**'
              - 'core/python/**'

  # ============================================================
  # JAVASCRIPT SDKs
  # ============================================================
  test-browser:
    needs: changes
    if: needs.changes.outputs.browser == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: core/browser/package-lock.json
      - run: npm ci
        working-directory: core/browser
      - run: npm test
        working-directory: core/browser
      - run: npm run build
        working-directory: core/browser

  test-node:
    needs: changes
    if: needs.changes.outputs.node == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: core/node/package-lock.json
      - run: npm ci
        working-directory: core/node
      - run: npm test
        working-directory: core/node
      - run: npm run build
        working-directory: core/node

  test-react:
    needs: [changes, test-browser]
    if: always() && (needs.changes.outputs.react == 'true' || github.ref == 'refs/heads/main') && (needs.test-browser.result == 'success' || needs.test-browser.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Build browser SDK first (dependency)
        run: npm ci && npm run build
        working-directory: core/browser
      - name: Install and test React SDK
        run: npm ci && npm test && npm run build
        working-directory: frameworks/react

  test-vue:
    needs: [changes, test-browser]
    if: always() && (needs.changes.outputs.vue == 'true' || github.ref == 'refs/heads/main') && (needs.test-browser.result == 'success' || needs.test-browser.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Build browser SDK first (dependency)
        run: npm ci && npm run build
        working-directory: core/browser
      - name: Install and test Vue SDK
        run: npm ci && npm test && npm run build
        working-directory: frameworks/vue

  # ============================================================
  # PHP SDKs
  # Note: Using 'composer update' to generate fresh lock file
  # compatible with each PHP version
  # ============================================================
  test-php:
    needs: changes
    if: needs.changes.outputs.php == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['8.1', '8.2', '8.3']
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          coverage: none
      - name: Install dependencies
        run: composer update --no-progress --prefer-dist
        working-directory: core/php
      - name: Run tests
        run: vendor/bin/phpunit
        working-directory: core/php

  test-symfony:
    needs: changes
    if: needs.changes.outputs.symfony == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['8.1', '8.2', '8.3']
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          coverage: none
      - name: Install dependencies
        run: composer update --no-progress --prefer-dist
        working-directory: frameworks/symfony
      - name: Run tests
        run: vendor/bin/phpunit
        working-directory: frameworks/symfony

  test-laravel:
    needs: changes
    if: needs.changes.outputs.laravel == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['8.2', '8.3']
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          coverage: none
      - name: Install dependencies
        run: composer update --no-progress --prefer-dist
        working-directory: frameworks/laravel
      - name: Run tests
        run: vendor/bin/phpunit
        working-directory: frameworks/laravel

  # ============================================================
  # PYTHON SDKs
  # ============================================================
  test-python:
    needs: changes
    if: needs.changes.outputs.python == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: pip install -e ".[dev]"
        working-directory: core/python
      - name: Run tests
        run: pytest tests/ -v
        working-directory: core/python

  test-django:
    needs: changes
    if: needs.changes.outputs.django == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install core SDK
        run: pip install -e .
        working-directory: core/python
      - name: Install Django SDK with dev dependencies
        run: pip install -e ".[dev]"
        working-directory: frameworks/django
      - name: Run tests
        run: pytest tests/ -v
        working-directory: frameworks/django

  test-flask:
    needs: changes
    if: needs.changes.outputs.flask == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install core SDK
        run: pip install -e .
        working-directory: core/python
      - name: Install Flask SDK with dev dependencies
        run: pip install -e ".[dev]"
        working-directory: frameworks/flask
      - name: Run tests
        run: pytest tests/ -v
        working-directory: frameworks/flask

  test-fastapi:
    needs: changes
    if: needs.changes.outputs.fastapi == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install core SDK
        run: pip install -e .
        working-directory: core/python
      - name: Install FastAPI SDK with dev dependencies
        run: pip install -e ".[dev]"
        working-directory: frameworks/fastapi
      - name: Run tests
        run: pytest tests/ -v
        working-directory: frameworks/fastapi
