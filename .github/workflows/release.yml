name: Release SDKs

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      sdks:
        description: 'SDKs to release (comma-separated or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - browser
          - node
          - react
          - vue
          - php
          - symfony
          - laravel
          - python
          - django
          - flask
          - fastapi
      dry_run:
        description: 'Dry run (no actual publish)'
        required: false
        default: false
        type: boolean

env:
  VERSION: ${{ github.event.inputs.version }}

jobs:
  # ============================================================
  # VALIDATE VERSION
  # ============================================================
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate version format
        run: |
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: $VERSION. Use semver (e.g., 1.0.0 or 1.0.0-beta.1)"
            exit 1
          fi
          echo "Version $VERSION is valid"

  # ============================================================
  # NPM: Browser SDK
  # ============================================================
  release-browser:
    needs: validate
    if: contains(github.event.inputs.sdks, 'browser') || github.event.inputs.sdks == 'all'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - run: npm version $VERSION --no-git-tag-version
        working-directory: core/browser
      - run: npm ci
        working-directory: core/browser
      - run: npm test
        working-directory: core/browser
      - run: npm run build
        working-directory: core/browser
      - name: Publish to NPM
        if: ${{ !inputs.dry_run }}
        run: npm publish --access public --provenance
        working-directory: core/browser
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ============================================================
  # NPM: Node SDK
  # ============================================================
  release-node:
    needs: validate
    if: contains(github.event.inputs.sdks, 'node') || github.event.inputs.sdks == 'all'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - run: npm version $VERSION --no-git-tag-version
        working-directory: core/node
      - run: npm ci
        working-directory: core/node
      - run: npm test
        working-directory: core/node
      - run: npm run build
        working-directory: core/node
      - name: Publish to NPM
        if: ${{ !inputs.dry_run }}
        run: npm publish --access public --provenance
        working-directory: core/node
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ============================================================
  # NPM: React SDK (depends on browser)
  # ============================================================
  release-react:
    needs: [validate, release-browser]
    if: always() && (contains(github.event.inputs.sdks, 'react') || github.event.inputs.sdks == 'all') && (needs.release-browser.result == 'success' || needs.release-browser.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - name: Build browser SDK dependency
        run: npm ci && npm run build
        working-directory: core/browser
      - run: npm version $VERSION --no-git-tag-version
        working-directory: frameworks/react
      - run: npm ci
        working-directory: frameworks/react
      - run: npm test
        working-directory: frameworks/react
      - run: npm run build
        working-directory: frameworks/react
      - name: Publish to NPM
        if: ${{ !inputs.dry_run }}
        run: npm publish --access public --provenance
        working-directory: frameworks/react
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ============================================================
  # NPM: Vue SDK (depends on browser)
  # ============================================================
  release-vue:
    needs: [validate, release-browser]
    if: always() && (contains(github.event.inputs.sdks, 'vue') || github.event.inputs.sdks == 'all') && (needs.release-browser.result == 'success' || needs.release-browser.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - name: Build browser SDK dependency
        run: npm ci && npm run build
        working-directory: core/browser
      - run: npm version $VERSION --no-git-tag-version
        working-directory: frameworks/vue
      - run: npm ci
        working-directory: frameworks/vue
      - run: npm test
        working-directory: frameworks/vue
      - run: npm run build
        working-directory: frameworks/vue
      - name: Publish to NPM
        if: ${{ !inputs.dry_run }}
        run: npm publish --access public --provenance
        working-directory: frameworks/vue
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ============================================================
  # PHP: Core SDK (Packagist auto-syncs from tags)
  # ============================================================
  release-php:
    needs: validate
    if: contains(github.event.inputs.sdks, 'php') || github.event.inputs.sdks == 'all'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
      - name: Update version
        run: |
          jq ".version = \"$VERSION\"" composer.json > tmp.json && mv tmp.json composer.json
        working-directory: core/php
      - run: composer update --no-progress --prefer-dist
        working-directory: core/php
      - run: vendor/bin/phpunit
        working-directory: core/php

  # ============================================================
  # PHP: Symfony SDK
  # ============================================================
  release-symfony:
    needs: [validate, release-php]
    if: always() && (contains(github.event.inputs.sdks, 'symfony') || github.event.inputs.sdks == 'all') && (needs.release-php.result == 'success' || needs.release-php.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
      - name: Update version
        run: |
          jq ".version = \"$VERSION\"" composer.json > tmp.json && mv tmp.json composer.json
        working-directory: frameworks/symfony
      - run: composer update --no-progress --prefer-dist
        working-directory: frameworks/symfony
      - run: vendor/bin/phpunit
        working-directory: frameworks/symfony

  # ============================================================
  # PHP: Laravel SDK
  # ============================================================
  release-laravel:
    needs: [validate, release-php]
    if: always() && (contains(github.event.inputs.sdks, 'laravel') || github.event.inputs.sdks == 'all') && (needs.release-php.result == 'success' || needs.release-php.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
      - name: Update version
        run: |
          jq ".version = \"$VERSION\"" composer.json > tmp.json && mv tmp.json composer.json
        working-directory: frameworks/laravel
      - run: composer update --no-progress --prefer-dist
        working-directory: frameworks/laravel
      - run: vendor/bin/phpunit
        working-directory: frameworks/laravel

  # ============================================================
  # Python: Core SDK
  # ============================================================
  release-python:
    needs: validate
    if: contains(github.event.inputs.sdks, 'python') || github.event.inputs.sdks == 'all'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Update version
        run: sed -i "s/version = \".*\"/version = \"$VERSION\"/" pyproject.toml
        working-directory: core/python
      - run: pip install build twine
      - run: pip install -e ".[dev]"
        working-directory: core/python
      - run: pytest tests/ -v
        working-directory: core/python
      - run: python -m build
        working-directory: core/python
      - name: Publish to PyPI
        if: ${{ !inputs.dry_run }}
        run: twine upload dist/*
        working-directory: core/python
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

  # ============================================================
  # Python: Django SDK
  # ============================================================
  release-django:
    needs: [validate, release-python]
    if: always() && (contains(github.event.inputs.sdks, 'django') || github.event.inputs.sdks == 'all') && (needs.release-python.result == 'success' || needs.release-python.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Update version
        run: sed -i "s/version = \".*\"/version = \"$VERSION\"/" pyproject.toml
        working-directory: frameworks/django
      - run: pip install build twine
      - name: Install core SDK
        run: pip install -e .
        working-directory: core/python
      - run: pip install -e ".[dev]"
        working-directory: frameworks/django
      - name: Run tests
        run: PYTHONPATH="${PYTHONPATH}:$(pwd)" pytest tests/ -v
        working-directory: frameworks/django
      - run: python -m build
        working-directory: frameworks/django
      - name: Publish to PyPI
        if: ${{ !inputs.dry_run }}
        run: twine upload dist/*
        working-directory: frameworks/django
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

  # ============================================================
  # Python: Flask SDK
  # ============================================================
  release-flask:
    needs: [validate, release-python]
    if: always() && (contains(github.event.inputs.sdks, 'flask') || github.event.inputs.sdks == 'all') && (needs.release-python.result == 'success' || needs.release-python.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Update version
        run: sed -i "s/version = \".*\"/version = \"$VERSION\"/" pyproject.toml
        working-directory: frameworks/flask
      - run: pip install build twine
      - name: Install core SDK
        run: pip install -e .
        working-directory: core/python
      - run: pip install -e ".[dev]"
        working-directory: frameworks/flask
      - run: pytest tests/ -v
        working-directory: frameworks/flask
      - run: python -m build
        working-directory: frameworks/flask
      - name: Publish to PyPI
        if: ${{ !inputs.dry_run }}
        run: twine upload dist/*
        working-directory: frameworks/flask
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

  # ============================================================
  # Python: FastAPI SDK
  # ============================================================
  release-fastapi:
    needs: [validate, release-python]
    if: always() && (contains(github.event.inputs.sdks, 'fastapi') || github.event.inputs.sdks == 'all') && (needs.release-python.result == 'success' || needs.release-python.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Update version
        run: sed -i "s/version = \".*\"/version = \"$VERSION\"/" pyproject.toml
        working-directory: frameworks/fastapi
      - run: pip install build twine
      - name: Install core SDK
        run: pip install -e .
        working-directory: core/python
      - run: pip install -e ".[dev]"
        working-directory: frameworks/fastapi
      - run: pytest tests/ -v
        working-directory: frameworks/fastapi
      - run: python -m build
        working-directory: frameworks/fastapi
      - name: Publish to PyPI
        if: ${{ !inputs.dry_run }}
        run: twine upload dist/*
        working-directory: frameworks/fastapi
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

  # ============================================================
  # CREATE GITHUB RELEASE (only if all succeeded and not dry run)
  # ============================================================
  create-release:
    needs: [release-browser, release-node, release-react, release-vue, release-php, release-symfony, release-laravel, release-python, release-django, release-flask, release-fastapi]
    if: always() && !inputs.dry_run && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Create Git Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }}
          body: |
            ## Error Explorer SDKs v${{ env.VERSION }}

            ### Packages Released

            **NPM:**
            - `@error-explorer/browser@${{ env.VERSION }}`
            - `@error-explorer/node@${{ env.VERSION }}`
            - `@error-explorer/react@${{ env.VERSION }}`
            - `@error-explorer/vue@${{ env.VERSION }}`

            **Packagist:**
            - `error-explorer/php-sdk:${{ env.VERSION }}`
            - `error-explorer/symfony-sdk:${{ env.VERSION }}`
            - `error-explorer/laravel-sdk:${{ env.VERSION }}`

            **PyPI:**
            - `error-explorer==${{ env.VERSION }}`
            - `error-explorer-django==${{ env.VERSION }}`
            - `error-explorer-flask==${{ env.VERSION }}`
            - `error-explorer-fastapi==${{ env.VERSION }}`
          draft: false
          prerelease: ${{ contains(env.VERSION, '-') }}
